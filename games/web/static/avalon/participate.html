<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <!-- <meta name="viewport" content="width=device-width, initial-scale=1.0"> -->
    <meta name="viewport"
        content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Avalon Game - Participate Mode</title>
    <link rel="stylesheet" href="/static/avalon/css/style.css?v=20251214">
    <script>
        window.__EARLY_INIT__ = { hasGameConfig: false, isGameRunning: false, config: null, portraits: null };
        (function () {
            try {
                var gameConfigStr = sessionStorage.getItem('gameConfig');
                var portraitsStr = sessionStorage.getItem('selectedPortraits');
                var myPlayerId = sessionStorage.getItem('my_player_id');

                // [CRITICAL FIX] 
                // Logic: If 'my_player_id' exists, it means we came from the Lobby (Host or Guest).
                // We DO NOT need gameConfig locally, the server has it.
                // Force Auto-Start immediately.

                if (myPlayerId !== null && myPlayerId !== undefined) {
                    window.__EARLY_INIT__.hasGameConfig = true; // Pretend we have config to satisfy logic
                    if (gameConfigStr) {
                        window.__EARLY_INIT__.config = JSON.parse(gameConfigStr);
                    }
                    document.documentElement.classList.add('auto-start');
                }
                // Fallback: Old local single player flow
                else if (gameConfigStr) {
                    window.__EARLY_INIT__.hasGameConfig = true;
                    window.__EARLY_INIT__.config = JSON.parse(gameConfigStr);
                    document.documentElement.classList.add('auto-start');
                }
                else {
                    document.documentElement.classList.add('manual-start');
                }

                if (portraitsStr) {
                    window.__EARLY_INIT__.portraits = JSON.parse(portraitsStr);
                }
            } catch (e) {
                console.error("Init Error:", e);
                document.documentElement.classList.add('manual-start');
            }
        })();
    </script>
    <style>
        /* Auto-start: Show Chat & Input, Hide Setup */
        html.auto-start #game-setup {
            display: none !important;
        }

        html.auto-start #messages-container {
            display: flex !important;
        }

        html.auto-start .input-container {
            display: flex !important;
        }

        /* Manual-start: Show Setup, Hide Chat */
        html.manual-start #game-setup {
            display: block !important;
        }

        html.manual-start #messages-container {
            display: none !important;
        }

        html.manual-start .input-container {
            display: none !important;
        }

        .waiting-message {
            color: var(--accent);
            text-align: center;
            padding: 20px;
            font-size: 10px;
        }

        /* Mobile Layout Refactoring */
        @media (max-width: 768px) {

            html,
            body {
                height: 100%;
                overflow: hidden;
                /* ç¦æ­¢é¡µé¢æ•´ä½“æ»šåŠ¨ */
            }

            .container {
                height: 100%;
                display: flex;
                flex-direction: column;
                padding: 4px;
                max-width: 100%;
            }

            /* Header å‹ç¼© */
            .header {
                flex-shrink: 0;
                margin-bottom: 4px;
            }

            .header-controls {
                margin-bottom: 4px;
                
            }

            .header-label,
            .header-btn {
                /*font-size: 10px !important;
                padding: 4px 8px !important;
                */
                /* ä» 10px ç¼©å°åˆ° 8pxï¼Œç¡®ä¿ä¸€è¡Œèƒ½æ”¾ä¸‹ */
                font-size: 9px !important; 
                
                /* ç¼©å°å†…è¾¹è·ï¼Œè®©æŒ‰é’®å˜ç˜¦ä¸€ç‚¹ */
                padding: 3px 7px !important;
                
                /* é˜²æ­¢æ–‡å­—æ¢è¡Œ */
                white-space: nowrap;
                
                /* ç¨å¾®é™ä½è¡Œé«˜ï¼Œæ›´ç´§å‡‘ */
                line-height: 1.2;
            }

            #status-bar {
                font-size: 9px;
                flex-wrap: wrap;
                gap: 4px;
            }

            /* ä¸»å†…å®¹åŒºåŸŸæ”¹ä¸ºå‚ç›´æ’åˆ— */
            .main-content {
                flex: 1;
                display: flex;
                flex-direction: column;
                overflow: hidden;
                /* é˜²æ­¢æº¢å‡º */
                gap: 6px;
            }

            .map-container {
                width: 100%;
                height: 22vh;
                /* ä» 45vh æ”¹ä¸º 32vh */
                min-height: 100px;
                flex-shrink: 0;
                margin-right: 0;
                border-bottom: 2px solid var(--border);
                z-index: 5;
                /* ç¡®ä¿å±‚çº§ */
            }

            /* è°ƒæ•´å†…éƒ¨åœºæ™¯é€‚åº”å®¹å™¨ */
            .table-scene {
                width: 100%;
                height: 100%;
                border-radius: 8px;
            }

            /* 2. å½»åº•éšè—æ¡Œå­å›¾ç‰‡ï¼ˆå®¶å…·æ‰”æ‰ï¼ï¼‰ */
            .pixel-table {
                display: none !important;
            }

            /* 3. ç¡®ä¿èŠå¤©åŒºåŸŸè‡ªåŠ¨å¡«å……å‰©ä½™é«˜åº¦ */
            .sidebar {
                width: 100%;
                flex: 1;
                min-height: 0;
                display: flex;
                flex-direction: column;
            }

            .panel.logs-panel {
                height: 100%;
                display: flex;
                flex-direction: column;
                border: 2px solid #20314a;
                /* ç¡®ä¿è¾¹ç•Œæ¸…æ™° */
            }

            .panel h3 {
                display: none;
            }

            /* éšè—æ ‡é¢˜ä»¥èŠ‚çœç©ºé—´ */

            #messages-container {
                flex: 1;
                overflow-y: auto;
                min-height: 0;
                padding: 6px;
                background: rgba(0, 0, 0, 0.2);
            }

            /* 3. åº•éƒ¨è¾“å…¥æ ä¼˜åŒ– (æ”¹ä¸ºæ°´å¹³æ’åˆ—) */
            .input-container {
                flex-shrink: 0;
                padding: 6px;
                background: #132238;
                border-top: 1px solid #20314a;
            }

            /* å¼ºåˆ¶è¾“å…¥æ¡†å’ŒæŒ‰é’®æ°´å¹³å¹¶æ’ */
            .input-container>div:last-child {
                flex-direction: row !important;
                /* è¦†ç›–å†…è”æ ·å¼çš„ column */
                align-items: center;
                gap: 6px;
            }

            #user-input {
                height: 36px !important;
                /* å¼ºåˆ¶å•è¡Œé«˜åº¦ */
                min-height: 36px;
                margin-bottom: 0;
                font-size: 12px;
                /* é˜²æ­¢ iOS ç¼©æ”¾ */
            }

            #send-button {
                width: auto !important;
                height: 36px;
                padding: 0 16px;
                margin-top: 0;
                display: flex;
                align-items: center;
                justify-content: center;
            }
        }

        /* è¯·æ’å…¥åˆ° participate.html çš„ <style> æ ‡ç­¾ç»“æŸå‰ */

        @media (max-width: 768px) {
            .map-container {
                /* 1. å¼ºåˆ¶è¦†ç›– min-height: 400px */
                min-height: 230px !important;

                /* 2. å¼ºåˆ¶æŒ‡å®šé«˜åº¦ï¼Œä¸è®¸ flex è‡ªåŠ¨ä¼¸ç¼© */
                height: 26vh !important;
                flex: none !important;

                /* 3. ç¡®ä¿è¾¹æ¡†å’Œå†…è¾¹è·åŒ…å«åœ¨é«˜åº¦å†… */
                box-sizing: border-box !important;
            }

            /* é¡ºä¾¿ä¿®å¤ä¾§è¾¹æ ï¼Œè®©å®ƒè‡ªåŠ¨å¡«æ»¡å‰©ä¸‹çš„ç©ºé—´ */
            .sidebar {
                height: auto !important;
                flex: 1 !important;
            }
        }

        /* --- ä¿®å¤å¤´åƒè¯´è¯ç¼©å°é—®é¢˜ --- */

        @media (max-width: 768px) {

            /* 1. å®šä¹‰ä¸€ä¸ªã€ç»å¯¹ä¸ç¼©æ”¾ã€‘çš„åŠ¨ç”»
       æ³¨æ„ï¼šè¿™é‡Œ transform é‡Œé¢åªæœ‰ rotateï¼Œæ²¡æœ‰ scaleï¼Œæˆ–è€…æ˜¾å¼å†™ scale(1) */
            @keyframes no-shrink-shake {

                0%,
                100% {
                    transform: scale(1) rotate(calc(var(--base-rotation, 0deg) - 2deg));
                }

                50% {
                    transform: scale(1) rotate(calc(var(--base-rotation, 0deg) + 2deg));
                }
            }

            /* 2. å¼ºåˆ¶ .speaking çŠ¶æ€ä½¿ç”¨è¿™ä¸ªæ–°åŠ¨ç”» */
            .seat.speaking {
                /* è¿™é‡Œçš„ !important æ˜¯å…³é”®ï¼Œé˜²æ­¢è¢« style.css é‡Œçš„æ—§åŠ¨ç”»è¦†ç›– */
                animation: no-shrink-shake 0.4s ease-in-out infinite, pulse-glow 1.5s ease-in-out infinite !important;

                /* ç¡®ä¿è¾¹æ¡†é«˜äº® */
                border-color: var(--accent) !important;
                z-index: 100;
            }

            /* 3. è¯´è¯æ—¶çš„æ°”æ³¡ä¹Ÿä¸è®¸ä¹±è·‘ */
            .seat.speaking .speech-bubble {
                transform: translateX(-50%) translateY(-5px) scale(1) !important;
                opacity: 1 !important;
            }
        }
        /* 1. å…¬å…±åŸºç¡€æ ·å¼ (ä¸¤ç«¯é€šç”¨ï¼šé¢œè‰²ã€å­—ä½“ã€è¾¹æ¡†) */
                    .host-only-btn {
                        position: absolute;
                        z-index: 100;
                        font-family: "Press Start 2P", monospace;
                        text-transform: uppercase;
                        letter-spacing: 1px;
                        
                        /* åƒç´ é£é…è‰² */
                        background: #3d0808 !important;
                        border: 2px solid #ff4444 !important; 
                        color: #ffcccc !important; 
                        
                        /* ç¡¬é˜´å½± */
                        box-shadow: 4px 4px 0px #1a0202; 
                        cursor: pointer;
                        
                        /* ä»…å…è®¸é¢œè‰²è¿‡æ¸¡ï¼Œç¦æ­¢ä½ç½®åŠ¨ç”» */
                        transition: background 0.1s, color 0.1s, border-color 0.1s;
                    }

                    /* å…¬å…±æ‚¬åœ/ç‚¹å‡»å˜è‰²æ•ˆæœ */
                    .host-only-btn:hover, 
                    .host-only-btn:active {
                        background: #660c0c; 
                        border-color: #ff6666;
                        color: #ffffff;
                    }

                    /* 2. ã€æ ¸å¿ƒéš”ç¦»ã€‘ç”µè„‘ç«¯ä¸“å±é€»è¾‘ (å±å¹•å®½åº¦ > 768px) */
                    /* è¿™æ®µä»£ç æ‰‹æœºæ ¹æœ¬çœ‹ä¸è§ï¼Œç»å¯¹ä¸ä¼šç¬ç§»ï¼ */
                    @media (min-width: 769px) {
                        .host-only-btn {
                            /* ç”µè„‘ç«¯å®šä½ï¼šæ­£ä¸­é—´ */
                            top: 50%;
                            left: 50%;
                            transform: translate(-50%, -50%);
                            
                            font-size: 10px;
                            padding: 10px 14px;
                        }

                        /* ç”µè„‘ç«¯æ‚¬åœä½ç½®é”æ­» */
                        .host-only-btn:hover, 
                        .host-only-btn:active {
                            transform: translate(-50%, -50%) !important;
                            top: 50% !important;
                            left: 50% !important;
                        }
                    }

                    /* 3. ã€æ ¸å¿ƒéš”ç¦»ã€‘æ‰‹æœºç«¯ä¸“å±é€»è¾‘ (å±å¹•å®½åº¦ <= 768px) */
                    @media (max-width: 768px) {
                        .host-only-btn {
                            /* æ‰‹æœºç«¯å®šä½ï¼šå³ä¸Šè§’ */
                            top: 6px;
                            right: 6px;
                            left: auto;   /* è¦†ç›– left */
                            bottom: auto;
                            transform: none; /* è¦†ç›– transform */
                            
                            font-size: 8px;
                            padding: 4px 8px;
                            border-width: 1px;
                            box-shadow: 2px 2px 0px #1a0202; /* é˜´å½±å˜è–„ */
                            z-index: 3000;
                        }
                        
                        /* æ‰‹æœºç«¯æ‚¬åœ/ç‚¹å‡»ä½ç½®é”æ­» */
                        /* å³ä½¿æŒ‰ä¸‹å»ï¼Œä¹Ÿå¼ºåˆ¶é’‰åœ¨å³ä¸Šè§’ */
                        .host-only-btn:hover, 
                        .host-only-btn:active,
                        .host-only-btn:focus {
                            top: 6px !important;
                            right: 6px !important;
                            left: auto !important;
                            transform: none !important;
                        }
                    }
        
    </style>
</head>

<body>
    <div id="connection-status" class="connection-status connecting">ğŸŸ¡ Connecting...</div>

    <div class="container">
        <div class="header">
            <div class="header-controls">
                <div class="header-label">Game: Avalon</div>
                <div class="header-btn">Mode: Participant</div>
            </div>
            <div id="status-bar">
                <span id="phase-display">Phase: -</span>
                <span id="mission-display">Mission: -</span>
                <span id="round-display">Round: -</span>
                <span id="status-display">Status: Connecting...</span>
            </div>
        </div>

        <div class="main-content">
            <div class="map-container" id="game-visual-container">
                <div id="game-setup" class="game-setup" style="display: none;">
                    <h3>âš” Game Configuration</h3>
                    <div class="setup-form">
                        <div class="waiting-message">
                            <strong>Session Error.</strong><br><br>
                            Missing Player ID. Please return to the <a href="/" style="color: #ffdd57;">Lobby</a> to
                            join properly.
                        </div>

                        <div style="opacity: 0.5; pointer-events: none;">
                            <label>Player ID: <select id="user-agent-id">
                                    <option value="0">0</option>
                                </select></label>
                            <button id="start-game-btn" class="start-button">Manual Force Start</button>
                        </div>
                    </div>
                </div>

                
                <div class="table-scene">
                    <div class="pixel-table">
                    </div>
                    <button id="host-reset-btn" class="pixel-btn host-only-btn" style="display: none;">
                        âš  TERMINATE GAME
                    </button>
                    <div class="table-players" id="table-players"></div>

                </div>

                <div id="modal-overlay" class="modal-overlay" style="display: none;">
                    <div id="host-confirm-modal" class="pixel-modal" style="display: none;">
                        <h3>âš  Terminate Game?</h3>
                        <p>This will end the current session for ALL players.</p>
                        <div class="modal-actions">
                            <button id="confirm-reset-yes" class="pixel-btn danger">YES</button>
                            <button id="confirm-reset-no" class="pixel-btn">NO</button>
                        </div>
                    </div>

                    <div id="game-ended-modal" class="pixel-modal" style="display: none;">
                        <h3 id="end-title">Game Ended</h3>
                        <p id="end-reason">The game has finished.</p>
                        <div class="modal-actions">
                            <button id="global-return-lobby-btn" class="pixel-btn primary">
                                ğŸ  Return to Lobby
                            </button>
                        </div>
                    </div>
                </div>

                <style>
                    /* ç®€å•çš„æ¨¡æ€æ¡†æ ·å¼è¡¥å…… */
                    .modal-overlay {
                        position: fixed;
                        top: 0;
                        left: 0;
                        width: 100%;
                        height: 100%;
                        /* 1. å»æ‰é»‘è‰²èƒŒæ™¯ï¼Œæ”¹ä¸ºé€æ˜ */
                        background: transparent !important;
                        background: rgba(0, 0, 0, 0.7);
                        z-index: 9999;
                        display: flex;
                        justify-content: center;
                        align-items: center;
                        /* 2. å…³é”®ï¼šå…è®¸é¼ æ ‡ç©¿é€é®ç½©å±‚ï¼Œè¿™æ ·ä½ å°±èƒ½æ»šåŠ¨åº•ä¸‹çš„èŠå¤©æ¡†äº† */
                        pointer-events: none !important;
                    }

                    .pixel-modal {
                        background: #2c2c2c;
                        border: 4px solid var(--accent);
                        padding: 20px;
                        text-align: center;
                        color: white;
                        image-rendering: pixelated;
                        box-shadow: 0 10px 0 rgba(0, 0, 0, 0.5);
                        /* 3. å…³é”®ï¼šæ¢å¤å¼¹çª—æœ¬èº«çš„é¼ æ ‡äº¤äº’ï¼Œå¦åˆ™æŒ‰é’®ç‚¹ä¸äº† */
                        pointer-events: auto !important;
                    }

                    .pixel-btn {
                        background: #444;
                        border: 2px solid white;
                        color: white;
                        padding: 10px 20px;
                        cursor: pointer;
                        font-family: inherit;
                        margin: 5px;
                    }

                    .pixel-btn:hover {
                        background: #666;
                        transform: translateY(-2px);
                    }

                    .pixel-btn.danger {
                        background: #aa2222;
                        border-color: #ff5555;
                    }

                    .pixel-btn.primary {
                        background: var(--accent);
                        border-color: white;
                        color: black;
                    }

                    /*.host-only-btn {
                        position: absolute;
                        top: 50%;
                        left: 50%;
                        transform: translate(-50%, -50%);
                        z-index: 100;
                        background: rgba(170, 34, 34, 0.9);
                    }
                    
                    .host-only-btn:hover {
                        transform: translate(-50%, -50%) !important;
                        background: rgba(150, 30, 30, 1) !important;
                    }*/
                    /* ================= æˆ¿ä¸»ç»ˆæ­¢æŒ‰é’® (æœ€ç»ˆå®Œç¾å…¼å®¹ç‰ˆ) ================= */
                    
                        /* --- ç”µè„‘ç«¯åŸºç¡€æ ·å¼ --- */
                        

                </style>

            </div>

            <div class="sidebar">
                <div class="panel logs-panel">
                    <h3>Chat</h3>
                    <div id="messages-container">
                        <div style="text-align: center; color: var(--muted); padding: 20px; font-size: 9px;">
                            Connecting to game server...
                        </div>
                    </div>

                    <div class="input-container">
                        <div id="user-input-request" style="display: none;">
                            <strong>Action Required:</strong> <span id="input-prompt">Please enter your move...</span>
                        </div>
                        <div style="display: flex; flex-direction: column; gap: 5px;">
                            <textarea id="user-input" placeholder="Type your message..." rows="3" disabled></textarea>
                            <button id="send-button" disabled>Send</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="/static/avalon/js/websocket.js"></script>
    <script src="/static/avalon/js/participate.js"></script>
</body>

</html>