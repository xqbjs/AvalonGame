<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Agent Config</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap" rel="stylesheet">
  <style>
    @font-face {
      font-family: "Ark Pixel";
      src: url("/static/fonts/ark-pixel-font.woff2") format("woff2");
      font-display: swap;
    }
    :root {
      --bg1: #0c1424;
      --bg2: #070c18;
      --panel: #132238;
      --panel2: #0d1829;
      --border: #20314a;
      --accent: #51f6a5;
      --accent2: #ffdd57;
      --text: #e9f2ff;
      --muted: #a9bedc;
      --shadow: 0 6px 0 #0a0f19;
    }
    * { box-sizing: border-box; }
    body {
      margin: 0;
      min-height: 100vh;
      background: radial-gradient(circle at 20% 20%, #1b2c47 0, var(--bg1) 45%, var(--bg2) 100%);
      color: var(--text);
      font-family: "Press Start 2P", "Ark Pixel", "Helvetica Neue", Arial, sans-serif;
      font-size: 13px;
      image-rendering: pixelated;
    }
    .page {
      max-width: 1200px;
      margin: 0 auto;
      padding: 20px 24px 32px;
    }
    header {
      display: flex;
      justify-content: space-between;
      align-items: flex-end;
      gap: 12px;
      flex-wrap: wrap;
      margin-bottom: 14px;
    }
    .title { font-size: 18px; letter-spacing: 1px; color: var(--accent2); text-shadow: 0 2px 0 #0b1628; }
    .subtitle { font-size: 10px; color: var(--muted); line-height: 1.5; }
    .panel {
      background: var(--panel);
      border: 2px solid var(--border);
      border-radius: 12px;
      box-shadow: var(--shadow);
      padding: 14px;
    }
    .grid {
      display: grid;
      grid-template-columns: 1fr;
      gap: 12px;
    }
    .row {
      display: grid;
      grid-template-columns: 86px 1fr;
      gap: 12px;
      padding: 12px;
      background: rgba(13,24,41,0.65);
      border: 2px solid #1c2b42;
      border-radius: 12px;
    }
    .portrait {
      width: 86px;
      height: 86px;
      border-radius: 12px;
      overflow: hidden;
      border: 2px solid var(--border);
      background: var(--panel2);
      box-shadow: 0 10px 0 #0a0f1c;
    }
    .portrait img { width: 100%; height: 100%; object-fit: cover; image-rendering: pixelated; }
    .fields {
      display: grid;
      grid-template-columns: repeat(5, minmax(0, 1fr));
      gap: 10px;
      align-items: start;
    }
    .field { display: flex; flex-direction: column; gap: 6px; }
    label { font-size: 9px; color: #cfe0ff; }
    input, select, textarea {
      font-family: "Press Start 2P", "Helvetica Neue", Arial, sans-serif;
      font-size: 10px;
      padding: 10px;
      border-radius: 10px;
      border: 2px solid #20314a;
      background: #0b1626;
      color: #e9f2ff;
      outline: none;
      width: 100%;
    }
    textarea { min-height: 44px; resize: vertical; }
    input:focus, select:focus, textarea:focus { border-color: var(--accent); }

    .toolbar {
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
      align-items: center;
      justify-content: space-between;
      margin-top: 12px;
    }
    .btn {
      font-family: "Press Start 2P", "Helvetica Neue", Arial, sans-serif;
      font-size: 10px;
      padding: 10px 12px;
      border-radius: 10px;
      border: 2px solid #20314a;
      background: linear-gradient(180deg, #2b4c6d, #1d3247);
      color: var(--text);
      cursor: pointer;
      box-shadow: 0 8px 0 #0b1628;
      transition: transform 0.12s ease, box-shadow 0.12s ease, opacity 0.12s ease;
      white-space: nowrap;
    }
    .btn:hover { transform: translateY(-2px); box-shadow: 0 10px 0 #0b1628; }
    .btn:active { transform: translateY(2px); box-shadow: 0 6px 0 #0b1628; }
    .btn.secondary { background: linear-gradient(180deg, #28364a, #1a2434); }
    .btn.danger { background: linear-gradient(180deg, #6d2b2b, #47201f); }

    .note { font-size: 9px; color: #b9cdeb; line-height: 1.6; }
    .ok { color: var(--accent); }
    .warn { color: var(--accent2); }

    @media (max-width: 980px) {
      .fields { grid-template-columns: 1fr; }
    }
  </style>
</head>
<body>
  <div class="page">
    <header>
      <div>
        <div class="title">Agent Config</div>
        <div class="subtitle">Bind base model and API info for each Agent (saved to local browser localStorage)</div>
      </div>
      <div class="subtitle">
        <a href="./index.html" id="back-link" style="color: var(--accent2); text-decoration: none;">Back to Agent Arena</a>
      </div>
    </header>

    <div class="panel">
      <div class="note">
        - base_model：e.g. `gpt-4o-mini` / your model name<br>
        - api_base：e.g. `https://api.openai.com/v1` or your proxy address<br>
        - api_key：only saved in local browser
      </div>
      <div class="toolbar">
        <div style="display:flex; gap:10px; flex-wrap:wrap;">
          <button class="btn" id="save">Save</button>

          <button class="btn danger" id="reset">Reset All</button>
        </div>
        <div class="note" id="status">Not saved</div>
      </div>
    </div>

    <div style="height: 12px;"></div>

    <div class="panel">
      <div class="grid" id="list"></div>
    </div>
  </div>

  <script>
    const STORAGE_KEY = "AgentConfigs.v1";
    const TOTAL = 15;
    const list = document.getElementById("list");
    const statusEl = document.getElementById("status");
    const API_OPTIONS_KEY_PREFIX = "apiOptions.v1.";

    let DEFAULT_PREFILL = { base_model: "", api_base: "", api_key: "", agent_class: "" };

    function loadCachedOptions(game) {
      try {
        const raw = localStorage.getItem(`${API_OPTIONS_KEY_PREFIX}${game}`);
        return raw ? JSON.parse(raw) : null;
      } catch {
        return null;
      }
    }

    async function fetchOptions(game, extra = "") {
      if (window.location.protocol === "file:") return null;
      try {
        const resp = await fetch(`/api/options?game=${game}${extra}`);
        if (!resp.ok) return null;
        return await resp.json();
      } catch {
        return null;
      }
    }

    async function loadDefaultPrefill() {
      const pickFrom = (opt) => {
        const default_role = opt && opt.default_role ? opt.default_role : null;
        const default_model = opt && opt.default_model ? opt.default_model : null;
        
        if (default_role) {
          const model_cfg = default_role.model || {};
          const agent_cfg = default_role.agent || {};
          return {
            base_model: model_cfg.model_name || "",
            api_base: model_cfg.url || model_cfg.api_base || "",
            api_key: model_cfg.api_key || "",
            agent_class: agent_cfg.type || "",
          };
        } else if (default_model) {
          return {
            base_model: default_model.model_name || "",
            api_base: default_model.api_base || default_model.url || "",
            api_key: default_model.api_key || "",
            agent_class: default_model.agent_class || "",
          };
        }
        return null;
      };

      try {
        if (window.location.protocol !== "file:") {
          const resp = await fetch("/api/options");  
          if (resp.ok) {
            const webOpts = await resp.json();
            DEFAULT_PREFILL = pickFrom(webOpts) || DEFAULT_PREFILL;
          }
        }
      } catch (e) {
        console.warn("Failed to fetch web config:", e);
      }
    }

    function loadConfig() {
      try {
        const raw = localStorage.getItem(STORAGE_KEY);
        if (!raw) return {};
        return JSON.parse(raw) || {};
      } catch {
        return {};
      }
    }

    function saveConfig(cfg) {
      localStorage.setItem(STORAGE_KEY, JSON.stringify(cfg));
    }

    function getPortraitSrc(id) {
      return "/static/portraits/portrait_" + id + ".png";
    }

    function render() {
      const cfg = loadConfig();
      list.innerHTML = "";
      for (let id = 1; id <= TOTAL; id++) {
        const row = document.createElement("div");
        row.className = "row";
      const current = cfg[id] || {};
      const base_model = current.base_model || DEFAULT_PREFILL.base_model || "";
      const api_base = current.api_base || DEFAULT_PREFILL.api_base || "";
      const api_key = current.api_key || DEFAULT_PREFILL.api_key || "";
      const agent_class = current.agent_class || DEFAULT_PREFILL.agent_class || "";

        row.innerHTML = `
          <div class="portrait">
            <img src="${getPortraitSrc(id)}" alt="Agent ${id}">
          </div>
          <div class="fields">
            <div class="field">
              <label>name</label>
              <input data-k="name" data-id="${id}" placeholder="Agent ${id}" value="${escapeAttr(current.name || "")}">
            </div>
            <div class="field">
              <label>base_model</label>
              <input data-k="base_model" data-id="${id}" placeholder="e.g. gpt-4o-mini" value="${escapeAttr(base_model)}">
            </div>
            <div class="field">
              <label>api_base</label>
              <input data-k="api_base" data-id="${id}" placeholder="e.g. https://api.openai.com/v1" value="${escapeAttr(api_base)}">
            </div>
            <div class="field">
              <label>api_key</label>
              <input data-k="api_key" data-id="${id}" placeholder="sk-..." value="${escapeAttr(api_key)}">
            </div>
            <div class="field">
              <label>agent_class</label>
              <input data-k="agent_class" data-id="${id}" placeholder="e.g. ThinkingReActAgent" value="${escapeAttr(agent_class)}">
            </div>
          </div>
        `;
        list.appendChild(row);
      }
    }

    function escapeAttr(s) {
      return String(s)
        .replaceAll("&", "&amp;")
        .replaceAll('"', "&quot;")
        .replaceAll("<", "&lt;")
        .replaceAll(">", "&gt;");
    }

    function collect() {
      const cfg = {};
      document.querySelectorAll("[data-k][data-id]").forEach(el => {
        const id = el.getAttribute("data-id");
        const k = el.getAttribute("data-k");
        cfg[id] = cfg[id] || {};
        cfg[id][k] = (el.value || "").trim();
      });
      Object.keys(cfg).forEach(id => {
        if (!cfg[id].agent_class) {
          cfg[id].agent_class = "";
        }
      });
      Object.keys(cfg).forEach(id => {
        const v = cfg[id];
        if (!v.name && !v.base_model && !v.api_base && !v.api_key && !v.agent_class) delete cfg[id];
      });
      return cfg;
    }

    document.getElementById("save").addEventListener("click", () => {
      const cfg = collect();
      saveConfig(cfg);
      
      localStorage.setItem("ConfigUpdateTime.v1", String(Date.now()));
      
      window.dispatchEvent(new Event('localStorageChange'));
      
      
      statusEl.innerHTML = '<span class="ok">Save Success</span>';
      setTimeout(() => (statusEl.textContent = "Save Success"), 400);
    });

    document.getElementById("reset").addEventListener("click", () => {
      if (!confirm("Clear all Agent configs?")) return;
      localStorage.removeItem(STORAGE_KEY);
      render();
      statusEl.innerHTML = '<span class="warn">Cleared</span>';
    });

    (async () => {
      await loadDefaultPrefill();
      render();
    })();

    document.getElementById('back-link').addEventListener('click', function() {
      sessionStorage.setItem('fromCharacterConfig', 'true');
    });
  </script>
</body>
</html>


